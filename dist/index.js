/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2017 Jakub Bene≈° <benes@webscope.io>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var React=_interopDefault(require("react")),PropTypes=_interopDefault(require("prop-types")),getCaretCoordinates=_interopDefault(require("textarea-caret")),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},objectWithoutProperties=function(e,t){var r={};for(var n in e)t.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},slicedToArray=function(){function e(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),KEY_CODES={ESC:27,UP:38,DOWN:40,ENTER:13,TAB:9},Listener=function e(){var t=this;classCallCheck(this,e),this.add=function(e,r){var n=e;return"object"!==(void 0===n?"undefined":_typeof(n))&&(n=[n]),t.listeners[t.index]={keyCode:n,fn:r},t.index+=1},this.remove=function(e){delete t.listeners[e],t.index-=1},this.removeAll=function(){return document.removeEventListener("keydown",t.f)},this.index=0,this.listeners={},this.f=function(e){for(var r=e.keyCode||e.which,n=0;n<t.index;n+=1){var o=t.listeners[n],a=o.keyCode,i=o.fn;a.includes(r)&&i(e)}},document.addEventListener("keydown",this.f)},Listeners=new Listener,Item=function(e){function t(){var e,r,n,o;classCallCheck(this,t);for(var a=arguments.length,i=Array(a),s=0;s<a;s++)i[s]=arguments[s];return r=n=possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),n.selectItem=function(){var e=n.props,t=e.item;(0,e.onSelectHandler)(t)},o=r,possibleConstructorReturn(n,o)}return inherits(t,e),createClass(t,[{key:"render",value:function(){var e=this.props,t=e.component,r=e.onClickHandler,n=e.item,o=e.selected;return React.createElement("li",{className:"rta__item"},React.createElement("div",{className:"rta__entity "+(!0===o?"rta__entity--selected":""),role:"button",tabIndex:0,onClick:r,onFocus:this.selectItem,onMouseEnter:this.selectItem},React.createElement(t,{selected:o,entity:n})))}}]),t}(React.Component),List=function(e){function t(){var e,r,n,o;classCallCheck(this,t);for(var a=arguments.length,i=Array(a),s=0;s<a;s++)i[s]=arguments[s];return r=n=possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),n.state={selectedItem:null},n.onPressEnter=function(e){e.preventDefault();var t=n.props.values;n.modifyText(t[n.getPositionInList()])},n.getPositionInList=function(){var e=n.props.values,t=n.state.selectedItem;return t?e.findIndex(function(e){return n.getId(e)===n.getId(t)}):0},n.getId=function(e){return n.props.getTextToReplace(e)},n.listeners=[],n.modifyText=function(e){if(e){var t=n.props;(0,t.onSelect)((0,t.getTextToReplace)(e))}},n.selectItem=function(e){n.setState({selectedItem:e})},n.scroll=function(e){e.preventDefault();var t=n.props.values,r=e.keyCode||e.which,o=n.getPositionInList(),a=void 0;switch(r){case KEY_CODES.DOWN:a=o+1;break;case KEY_CODES.UP:a=o-1;break;default:a=o}a=(a%t.length+t.length)%t.length,n.setState({selectedItem:t[a]})},n.isSelected=function(e){var t=n.state.selectedItem;return!!t&&n.getId(t)===n.getId(e)},o=r,possibleConstructorReturn(n,o)}return inherits(t,e),createClass(t,[{key:"componentDidMount",value:function(){this.listeners.push(Listeners.add([KEY_CODES.DOWN,KEY_CODES.UP],this.scroll),Listeners.add([KEY_CODES.ENTER,KEY_CODES.TAB],this.onPressEnter));var e=this.props.values;e&&e[0]&&this.selectItem(e[0])}},{key:"componentWillReceiveProps",value:function(e){var t=e.values;t&&t[0]&&this.selectItem(t[0])}},{key:"componentWillUnmount",value:function(){for(var e=void 0;this.listeners.length;)e=this.listeners.pop(),Listeners.remove(e)}},{key:"render",value:function(){var e=this,t=this.props,r=t.values,n=t.component;return React.createElement("ul",{className:"rta__list"},r.map(function(t){return React.createElement(Item,{key:e.getId(t),selected:e.isSelected(t),item:t,onClickHandler:e.onPressEnter,onSelectHandler:e.selectItem,component:n})}))}}]),t}(React.Component),ReactTextareaAutocomplete=function(e){function t(e){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));_initialiseProps.call(r),Listeners.add(KEY_CODES.ESC,function(){return r.closeAutocomplete()});var n=r.props,o=n.loadingComponent,a=n.trigger,i=n.value;if(i&&(r.state.value=i),r.tokenRegExp=new RegExp("["+Object.keys(a).join("")+"]\\w*$"),!o)throw new Error("RTA: loadingComponent is not defined");if(!a)throw new Error("RTA: trigger is not defined");return r}return inherits(t,e),createClass(t,[{key:"componentWillReceiveProps",value:function(e){this.update(e)}},{key:"componentWillUnmount",value:function(){Listeners.removeAll()}},{key:"update",value:function(e){var t=e.value,r=e.trigger,n=this.state.value,o=this.props.trigger;t===n&&n||this.setState({value:t}),r===o&&this.tokenRegExp||(this.tokenRegExp=new RegExp("["+Object.keys(r).join("")+"]\\w*$"))}},{key:"render",value:function(){var e=this,t=this.props,r=t.loadingComponent,n=objectWithoutProperties(t,["loadingComponent"]),o=this.state,a=o.left,i=o.top,s=o.dataLoading,l=o.component,c=o.value,u=this.getSuggestions(),p=this.getTextToReplace();return React.createElement("div",{className:"rta "+(!0===s?"rta--loading":"")},React.createElement("textarea",_extends({ref:function(t){return e.textareaRef=t},className:"rta__textarea "+(n.className||""),onChange:this.changeHandler,value:c},this.cleanUpProps())),(s||u)&&React.createElement("div",{style:{top:i,left:a},className:"rta__autocomplete"},u&&l&&p&&React.createElement(List,{values:u,component:l,getTextToReplace:p,onSelect:this.onSelect}),s&&React.createElement("div",{className:"rta__loader "+(null!==u?"rta__loader--suggestion-data":"rta__loader--empty-suggestion-data")},React.createElement(r,{data:u}))))}}]),t}(React.Component);ReactTextareaAutocomplete.defaultProps={value:"",onChange:function(){return!0}};var _initialiseProps=function(){var e=this;this.state={top:0,left:0,currentTrigger:null,actualToken:"",data:null,value:"",dataLoading:!1,selectionEnd:0,selectionStart:0,component:null},this.onSelect=function(t){for(var r=e.state,n=r.selectionEnd,o=r.value,a=e.props.onChange,i=0;o[n+i]&&/\S/.test(o[n+i]);)i+=1;var s=o.slice(0,n+i),l=s.search(/\S*$/),c=l+t.length,u=s.substring(0,l)+t;e.setState({value:o.replace(s,u),dataLoading:!1},function(){var t=new Event("change",{bubbles:!0});e.textareaRef.dispatchEvent(t),a&&a(t),e.setTextareaCaret(c)}),e.closeAutocomplete()},this.getTextToReplace=function(){var t=e.state.currentTrigger,r=e.getCurrentTriggerSettings();if(!t||!r)return function(){return""};var n=r.output;return function(e){if("object"===(void 0===e?"undefined":_typeof(e))){if(!n||"function"!=typeof n)throw new Error("RTA: Output function is not defined!");return n(e,t)}return t+e}},this.setTextareaCaret=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e.textareaRef&&(e.textareaRef.focus(),e.textareaRef.setSelectionRange(t,t))},this.getCurrentTriggerSettings=function(){var t=e.state.currentTrigger;return t?e.props.trigger[t]:null},this.getValuesFromProvider=function(){var t=e.state,r=t.currentTrigger,n=t.actualToken,o=e.getCurrentTriggerSettings();if(r&&o){var a=o.dataProvider,i=o.component;if("function"!=typeof a)throw new Error("RTA: Trigger provider has to be a function!");e.setState({dataLoading:!0});var s=a(n);s instanceof Promise||(s=Promise.resolve(s)),s.then(function(t){if("object"!==(void 0===s?"undefined":_typeof(s)))throw new Error("RTA: Trigger provider has to provide an array!");if("function"!=typeof i)throw new Error("RTA: Component should be defined!");e.setState({dataLoading:!1,data:t,component:i})}).catch(function(e){throw new Error("RTA: dataProvider fails: "+e.message)})}},this.getSuggestions=function(){var t=e.state,r=t.currentTrigger,n=t.data;return!r||!n||n&&!n.length?null:n},this.closeAutocomplete=function(){e.getSuggestions()&&e.setState({data:null})},this.cleanUpProps=function(){var t=_extends({},e.props),r=["loadingComponent","ref","onChange","className","value","trigger"];for(var n in t)r.includes(n)&&delete t[n];return t},this.changeHandler=function(t){var r=e.props,n=r.trigger,o=r.onChange,a=t.target,i=a.selectionEnd,s=a.selectionStart,l=a.value;o&&(t.persist(),o(t)),e.setState({value:l});var c=e.tokenRegExp.exec(l.slice(0,i)),u=c&&c[0];if(!u||u.length<=1)e.closeAutocomplete();else{var p=Object.keys(n),f=u&&p.find(function(e){return e===u[0]})||null,d=u.slice(1);if(f){var g=getCaretCoordinates(a,i),h=g.top,v=g.left;e.setState({top:h,left:v}),e.setState({selectionEnd:i,selectionStart:s,currentTrigger:f,actualToken:d},e.getValuesFromProvider)}}}},triggerPropsCheck=function(e){var t=e.trigger;if(!t)return Error("Invalid prop trigger. Prop missing.");for(var r=Object.entries(t),n=0;n<r.length;n+=1){var o=slicedToArray(r[n],2),a=o[0],i=o[1];if("string"!=typeof a||1!==a.length)return Error("Invalid prop trigger. Keys of the object has to be string.");var s=i.component,l=i.dataProvider;if(!s||"function"!=typeof s)return Error("Invalid prop trigger: component should be defined.");if(!l||"function"!=typeof l)return Error("Invalid prop trigger: dataProvider should be defined.")}return null};ReactTextareaAutocomplete.propTypes={trigger:triggerPropsCheck,loadingComponent:PropTypes.func.isRequired,value:PropTypes.string},module.exports=ReactTextareaAutocomplete;
