/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2017 Jakub Beneš <benes@webscope.io>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}var React=_interopDefault(require("react")),PropTypes=_interopDefault(require("prop-types")),index=createCommonjsModule(function(e){!function(){function t(){for(var e=[],r=0;r<arguments.length;r++){var o=arguments[r];if(o){var a=typeof o;if("string"===a||"number"===a)e.push(o);else if(Array.isArray(o))e.push(t.apply(null,o));else if("object"===a)for(var i in o)n.call(o,i)&&o[i]&&e.push(i)}}return e.join(" ")}var n={}.hasOwnProperty;e.exports?e.exports=t:window.classNames=t}()}),index$1=createCommonjsModule(function(e){!function(){var t=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],n="undefined"!=typeof window,r=n&&null!=window.mozInnerScreenX;e.exports=function(e,o,a){if(!n)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var i=a&&a.debug||!1;if(i){var s=document.querySelector("#input-textarea-caret-position-mirror-div");s&&s.parentNode.removeChild(s)}var l=document.createElement("div");l.id="input-textarea-caret-position-mirror-div",document.body.appendChild(l);var c=l.style,u=window.getComputedStyle?getComputedStyle(e):e.currentStyle;c.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(c.wordWrap="break-word"),c.position="absolute",i||(c.visibility="hidden"),t.forEach(function(e){c[e]=u[e]}),r?e.scrollHeight>parseInt(u.height)&&(c.overflowY="scroll"):c.overflow="hidden",l.textContent=e.value.substring(0,o),"INPUT"===e.nodeName&&(l.textContent=l.textContent.replace(/\s/g," "));var p=document.createElement("span");p.textContent=e.value.substring(o)||".",l.appendChild(p);var d={top:p.offsetTop+parseInt(u.borderTopWidth),left:p.offsetLeft+parseInt(u.borderLeftWidth)};return i?p.style.backgroundColor="#aaa":document.body.removeChild(l),d}}()}),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},objectWithoutProperties=function(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},KEY_CODES={ESC:27,UP:38,DOWN:40,ENTER:13},Listeners=function(){var e=0,t={},n=function(n){for(var r=n.keyCode||n.which,o=0;o<e;o++){var a=t[o],i=a.keyCode,s=a.fn;i.includes(r)&&s(n)}};return document.addEventListener("keydown",n),{add:function(n,r){return"object"!==(void 0===n?"undefined":_typeof(n))&&(n=[n]),t[e]={keyCode:n,fn:r},e++},remove:function(n){delete t[n],e--},removeAll:function(){return document.removeEventListener("keydown",n)}}}(),Item=function(e){function t(){var e,n,r,o;classCallCheck(this,t);for(var a=arguments.length,i=Array(a),s=0;s<a;s++)i[s]=arguments[s];return n=r=possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),r.onMouseEnterHandler=function(){var e=r.props,t=e.item;(0,e.onMouseEnterHandler)(t)},o=n,possibleConstructorReturn(r,o)}return inherits(t,e),createClass(t,[{key:"render",value:function(){var e=this.props,t=e.component,n=(e.onMouseEnterHandler,e.onClickHandler),r=e.item,o=e.selected;return React.createElement("li",{className:index("rta__item",{"rta__item--selected":o}),onClick:n,onMouseEnter:this.onMouseEnterHandler},React.createElement(t,{selected:o,entity:r}))}}]),t}(React.Component),List=function(e){function t(){var e,n,r,o;classCallCheck(this,t);for(var a=arguments.length,i=Array(a),s=0;s<a;s++)i[s]=arguments[s];return n=r=possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),r.listeners=[],r.state={selected:null,selectedItem:null},r.getPositionInList=function(){var e=r.props.values,t=r.state.selectedItem;return t?e.findIndex(function(e){return r.getId(e)===r.getId(t)}):0},r.scroll=function(e){e.preventDefault();var t=r.props.values,n=e.keyCode||e.which,o=r.getPositionInList(),a=void 0;switch(n){case KEY_CODES.DOWN:a=o+1;break;case KEY_CODES.UP:a=o-1;break;default:a=o}a=(a%t.length+t.length)%t.length,r.setState({selectedItem:t[a]})},r.onPressEnter=function(e){e.preventDefault();var t=r.props.values;r.modifyText(t[r.getPositionInList()])},r.modifyText=function(e){if(e){var t=r.props;(0,t.onSelect)((0,t.getTextToReplace)(e))}},r.selectItem=function(e){r.setState({selectedItem:e})},r.getId=function(e){return r.props.getTextToReplace(e)},r.isSelected=function(e){var t=r.state.selectedItem;return!!t&&r.getId(t)===r.getId(e)},o=n,possibleConstructorReturn(r,o)}return inherits(t,e),createClass(t,[{key:"componentDidMount",value:function(){var e=this.props.values;this.setState({selectedItem:e[0]}),this.listeners.push(Listeners.add([KEY_CODES.DOWN,KEY_CODES.UP],this.scroll),Listeners.add([KEY_CODES.ENTER],this.onPressEnter))}},{key:"componentWillUnmount",value:function(){for(var e=void 0;e=this.listeners.pop();)Listeners.remove(e)}},{key:"render",value:function(){var e=this,t=this.props,n=t.values,r=t.component;if(r)return React.createElement("ul",{className:"rta__list"},n.map(function(t){return React.createElement(Item,{key:e.getId(t),selected:e.isSelected(t),item:t,onClickHandler:e.onPressEnter,onMouseEnterHandler:e.selectItem,component:r})}))}}]),t}(React.PureComponent),ReactTextareaAutocomplete=function(e){function t(){var e,n,r,o;classCallCheck(this,t);for(var a=arguments.length,i=Array(a),s=0;s<a;s++)i[s]=arguments[s];return n=r=possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),r.update=function(e){var t=r.props.trigger;r.tokenRegExp=new RegExp("["+Object.keys(t).join("")+"]\\w*$")},r.textareaRef=null,r.state={top:0,left:0,currentTrigger:null,actualToken:"",data:null,value:"",dataLoading:!1,selectionEnd:0,selectionStart:0,component:null},r.changeHandler=function(e){var t=r.props,n=t.trigger,o=t.onChange,a=e.target,i=a.selectionEnd,s=a.selectionStart,l=a.value;o&&(e.persist(),o(e)),r.setState({value:l});var c=r.tokenRegExp.exec(l.slice(0,i)),u=c&&c[0];if(!u||u.length<=1)r.closeAutocomplete();else{var p=Object.keys(n),d=u&&p.find(function(e){return e===u[0]})||null,f=u.slice(1);if(d){try{var g=index$1(a,i),h=g.top,m=g.left;r.setState({top:h,left:m})}catch(e){console.warn("RTA: failed to get caret coordinates. This is not a browser?")}r.setState({selectionEnd:i,selectionStart:s,currentTrigger:d,actualToken:f},r.getValuesFromProvider)}}},r.getTextToReplace=function(){var e=r.state.currentTrigger,t=r.getCurrentTriggerSettings();if(e&&t){var n=t.output;return function(t){if("object"===(void 0===t?"undefined":_typeof(t))){if(!n||"function"!=typeof n)throw new Error("RTA: Output function is not defined!");return n(t,e)}return e+t}}},r.closeAutocomplete=function(){r.getSuggestions()&&r.setState({data:null})},r.onSelect=function(e){for(var t=r.state,n=(t.actualToken,t.selectionEnd),o=(t.selectionStart,t.value),a=0;o[n+a]&&/\S/.test(o[n+a]);)a++;var i=o.slice(0,n+a),s=i.search(/\S*$/),l=s+e.length,c=i.substring(0,s)+e;r.setState({value:o.replace(i,c)},function(){return r.setTextareaCaret(l)}),r.closeAutocomplete()},r.setTextareaCaret=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;r.textareaRef&&r.textareaRef.setSelectionRange(e,e)},r.getCurrentTriggerSettings=function(){var e=r.state.currentTrigger;return e?r.props.trigger[e]:null},r.getValuesFromProvider=function(){var e=r.state,t=e.currentTrigger,n=e.actualToken,o=r.getCurrentTriggerSettings();if(t&&o){var a=o.dataProvider,i=o.component;if("function"!=typeof a)throw new Error("RTA: Trigger provider has to be a function!");r.setState({dataLoading:!0,data:null});var s=a(n);s instanceof Promise||(s=Promise.resolve(s)),s.then(function(e){if("object"!==(void 0===s?"undefined":_typeof(s)))throw new Error("RTA: Trigger provider has to provide an array!");if("function"!=typeof i)throw new Error("RTA: Component should be defined!");r.setState({dataLoading:!1,data:e,component:i})}).catch(function(e){throw new Error("RTA: dataProvider fails: "+e.message)})}},r.cleanUpProps=function(){var e=_extends({},r.props),t=["loadingComponent","ref","onChange","className","value","trigger"];for(var n in e)t.includes(n)&&delete e[n];return e},r.getSuggestions=function(){var e=r.state,t=e.currentTrigger,n=e.data;return!t||!n||n&&!n.length?null:n},o=n,possibleConstructorReturn(r,o)}return inherits(t,e),createClass(t,[{key:"componentDidMount",value:function(){var e=this;this.update(this.props),Listeners.add(KEY_CODES.ESC,function(t){return e.closeAutocomplete()});var t=this.props,n=t.loadingComponent,r=t.trigger;if(!n)throw new Error("RTA: loadingComponent is not defined");if(!r)throw new Error("RTA: trigger is not defined")}},{key:"componentWillUnmount",value:function(){Listeners.removeAll()}},{key:"componentDidUpdate",value:function(e){this.update(e)}},{key:"render",value:function(){var e=this,t=this.props,n=t.loadingComponent,r=objectWithoutProperties(t,["loadingComponent"]),o=this.state,a=o.left,i=o.top,s=(o.currentTrigger,o.dataLoading),l=o.component,c=o.value,u=this.getSuggestions(),p=this.getTextToReplace();return React.createElement("div",{className:index("rta",{"rta--loading":s})},React.createElement("textarea",_extends({ref:function(t){return e.textareaRef=t},className:"rta__textarea "+(r.className||""),onChange:this.changeHandler,value:c},this.cleanUpProps())),(s||u)&&React.createElement("div",{style:{top:i,left:a},className:"rta__autocomplete"},s&&React.createElement("div",{className:"rta__loader"},React.createElement(n,null)),u&&l&&p&&React.createElement(List,{values:u,component:l,getTextToReplace:p,onSelect:this.onSelect})))}}]),t}(React.Component);ReactTextareaAutocomplete.propTypes={trigger:PropTypes.object.isRequired,loadingComponent:PropTypes.func.isRequired},module.exports=ReactTextareaAutocomplete;
